<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="admin-dashboard.html" class="nav-item">
                    <span>üìä</span> Dashboard
                </a>
                <a href="admin-categories.html" class="nav-item">
                    <span>üìÅ</span> Categories
                </a>
                <a href="admin-products.html" class="nav-item active">
                    <span>üõçÔ∏è</span> Products
                </a>
                <a href="admin-settings.html" class="nav-item">
                    <span>‚öôÔ∏è</span> Settings
                </a>
                <a href="#" class="nav-item" onclick="AdminAuth.logout()">
                    <span>üö™</span> Logout
                </a>
            </nav>
        </aside>

        <main class="admin-main">
            <header class="admin-header">
                <h1>Products</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showAddProductModal()">Add Product</button>
                </div>
            </header>

            <div class="content-section">
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modalTitle">Add Product</h3>
                <span class="close" onclick="closeProductModal()">&times;</span>
            </div>
            <form id="productForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="productName">Product Name</label>
                        <input type="text" id="productName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Price (‚Ç¶)</label>
                        <input type="number" id="productPrice" name="price" min="0" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productCategory">Category</label>
                        <select id="productCategory" name="category_id" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productStock">Stock Status</label>
                        <select id="productStock" name="in_stock" required>
                            <option value="true">In Stock</option>
                            <option value="false">Sold Out</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productDescription">Description</label>
                    <textarea id="productDescription" name="description" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="productImage">Product Image</label>
                    <input type="file" id="productImage" accept="image/*">
                    <div id="imagePreview" class="image-preview"></div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script>
        AdminAuth.requireAuth();

        let editingProductId = null;
        let categories = [];

        async function loadCategories() {
            try {
                categories = await CategoriesAPI.getAll();
                const select = document.getElementById('productCategory');
                select.innerHTML = '<option value="">Select Category</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadProducts() {
            try {
                const products = await ProductsAPI.getAll();
                const tbody = document.getElementById('productsTableBody');
                
                tbody.innerHTML = products.map(product => `
                    <tr>
                        <td>
                            ${product.image_url ? 
                                `<img src="${product.image_url}" alt="${product.name}" class="product-thumb">` : 
                                '<div class="no-image">No Image</div>'
                            }
                        </td>
                        <td>${product.name}</td>
                        <td>${product.categories ? product.categories.name : 'No Category'}</td>
                        <td>‚Ç¶${parseFloat(product.price).toLocaleString()}</td>
                        <td>
                            <span class="stock-badge ${product.in_stock ? 'in-stock' : 'out-of-stock'}">
                                ${product.in_stock ? 'In Stock' : 'Sold Out'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editProduct('${product.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading products:', error);
                alert('Error loading products');
            }
        }

        function showAddProductModal() {
            document.getElementById('modalTitle').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            editingProductId = null;
            document.getElementById('productModal').style.display = 'block';
        }

        async function editProduct(id) {
            try {
                const products = await ProductsAPI.getAll();
                const product = products.find(p => p.id === id);
                
                if (product) {
                    document.getElementById('modalTitle').textContent = 'Edit Product';
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('productCategory').value = product.category_id || '';
                    document.getElementById('productStock').value = product.in_stock.toString();
                    
                    const imagePreview = document.getElementById('imagePreview');
                    if (product.image_url) {
                        imagePreview.innerHTML = `<img src="${product.image_url}" alt="Current image">`;
                    }
                    
                    editingProductId = id;
                    document.getElementById('productModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading product for edit:', error);
                alert('Error loading product');
            }
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await ProductsAPI.delete(id);
                    loadProducts();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product');
                }
            }
        }

        // Image preview
        document.getElementById('productImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const imageFile = document.getElementById('productImage').files[0];
            
            try {
                let imageUrl = '';
                
                // Upload image if provided
                if (imageFile) {
                    imageUrl = await ProductsAPI.uploadImage(imageFile);
                }
                
                const productData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    price: parseFloat(formData.get('price')),
                    category_id: formData.get('category_id') || null,
                    in_stock: formData.get('in_stock') === 'true'
                };
                
                if (imageUrl) {
                    productData.image_url = imageUrl;
                }
                
                if (editingProductId) {
                    await ProductsAPI.update(editingProductId, productData);
                } else {
                    await ProductsAPI.create(productData);
                }
                
                closeProductModal();
                loadProducts();
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Error saving product: ' + error.message);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadProducts();
        });
    </script>
</body>
</html>