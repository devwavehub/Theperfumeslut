<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2>The Perfume Slut</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="admin-dashboard.html" class="nav-item">
                    <span>üìä</span> <span class="nav-item-text">Dashboard</span>
                </a>
                <a href="admin-categories.html" class="nav-item">
                    <span>üìÅ</span> <span class="nav-item-text">Categories</span>
                </a>
                <a href="admin-products.html" class="nav-item active">
                    <span>üõçÔ∏è</span> <span class="nav-item-text">Products</span>
                </a>
                <a href="admin-settings.html" class="nav-item">
                    <span>‚öôÔ∏è</span> <span class="nav-item-text">Settings</span>
                </a>
                <a href="#" class="nav-item" onclick="AdminAuth.logout()">
                    <span>üö™</span> <span class="nav-item-text">Logout</span>
                </a>
            </nav>
        </aside>

        <main class="admin-main">
            <header class="admin-header">
                <button class="mobile-nav-toggle" id="mobileNavToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <h1>Products</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showAddProductModal()">Add Product</button>
                </div>
            </header>

            <div class="content-section">
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modalTitle">Add Product</h3>
                <span class="close" onclick="closeProductModal()">&times;</span>
            </div>
            <form id="productForm">
                <div class="modal-body">
                    <div class="product-form-layout">
                        <div class="product-form-fields">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productName">Product Name</label>
                                    <input type="text" id="productName" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="productPrice">Price (‚Ç¶)</label>
                                    <input type="number" id="productPrice" name="price" min="0" step="0.01" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productCategory">Category</label>
                                    <select id="productCategory" name="category_id" required>
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="productStock">Stock Status</label>
                                    <select id="productStock" name="in_stock" required>
                                        <option value="true">In Stock</option>
                                        <option value="false">Sold Out</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="productDescription">Description</label>
                                <textarea id="productDescription" name="description"></textarea>
                            </div>
                        </div>
                        <div class="product-form-image">
                             <div class="form-group">
                                <label for="productImage">Product Image</label>
                                <input type="file" id="productImage" accept="image/*" class="image-input">
                                <label for="productImage" class="image-drop-zone">
                                    <div id="imagePreview" class="image-preview">
                                        <div class="image-placeholder">
                                            <span>üì∑</span>
                                            <p>Click or drag to upload</p>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <div class="mobile-nav-menu" id="mobileNavMenu">
        <a href="admin-dashboard.html" class="nav-item"><span>üìä</span> Dashboard</a>
        <a href="admin-categories.html" class="nav-item"><span>üìÅ</span> Categories</a>
        <a href="admin-products.html" class="nav-item active"><span>üõçÔ∏è</span> Products</a>
        <a href="admin-settings.html" class="nav-item"><span>‚öôÔ∏è</span> Settings</a>
        <a href="#" class="nav-item" onclick="AdminAuth.logout()"><span>üö™</span> Logout</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { AdminAuth, CategoriesAPI, ProductsAPI } from './js/supabase.js';
        import { setupMobileNav } from './js/admin-nav.js';

        window.AdminAuth = AdminAuth;
        let editingProductId = null;

        async function loadCategories() {
            try {
                const categories = await CategoriesAPI.getAll();
                const select = document.getElementById('productCategory');
                select.innerHTML = '<option value="">Select Category</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadProducts() {
            try {
                const products = await ProductsAPI.getAll();
                const tbody = document.getElementById('productsTableBody');
                
                tbody.innerHTML = products.map(product => `
                    <tr>
                        <td data-label="Image">
                            ${product.image_url ? 
                                `<img src="${product.image_url}" alt="${product.name}" class="product-thumb">` : 
                                '<div class="no-image">No Image</div>'
                            }
                        </td>
                        <td data-label="Name">${product.name}</td>
                        <td data-label="Category">${product.categories ? product.categories.name : 'Uncategorized'}</td>
                        <td data-label="Price">‚Ç¶${parseFloat(product.price).toLocaleString()}</td>
                        <td data-label="Stock">
                            <span class="stock-badge ${product.in_stock ? 'in-stock' : 'out-of-stock'}">
                                ${product.in_stock ? 'In Stock' : 'Sold Out'}
                            </span>
                        </td>
                        <td data-label="Actions">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-secondary" onclick="editProduct('${product.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading products:', error);
                alert('Error loading products');
            }
        }
        
        const imagePreview = document.getElementById('imagePreview');
        const imagePlaceholder = imagePreview.querySelector('.image-placeholder');

        function updateImagePreview(src) {
            // Clear previous preview
            const existingImg = imagePreview.querySelector('img');
            if (existingImg) {
                existingImg.remove();
            }

            if (src) {
                const img = document.createElement('img');
                img.src = src;
                imagePreview.appendChild(img);
                imagePlaceholder.style.display = 'none';
            } else {
                imagePlaceholder.style.display = 'flex';
            }
        }

        window.showAddProductModal = function() {
            document.getElementById('modalTitle').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            updateImagePreview(null);
            editingProductId = null;
            document.getElementById('productModal').style.display = 'flex';
        }

        window.editProduct = async function(id) {
            try {
                const product = await ProductsAPI.getById(id);
                
                if (product) {
                    document.getElementById('modalTitle').textContent = 'Edit Product';
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('productCategory').value = product.category_id || '';
                    document.getElementById('productStock').value = product.in_stock.toString();
                    
                    updateImagePreview(product.image_url);
                    
                    editingProductId = id;
                    document.getElementById('productModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading product for edit:', error);
                alert('Error loading product');
            }
        }

        window.closeProductModal = function() {
            document.getElementById('productModal').style.display = 'none';
        }

        window.deleteProduct = async function(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await ProductsAPI.delete(id);
                    loadProducts();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product');
                }
            }
        }

        document.getElementById('productImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateImagePreview(e.target.result);
                };
                reader.readAsURL(file);
            }
        });

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';
            
            const formData = new FormData(e.target);
            const imageFile = document.getElementById('productImage').files[0];
            
            try {
                let imageUrl;
                
                if (imageFile) {
                    imageUrl = await ProductsAPI.uploadImage(imageFile);
                }
                
                const productData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    price: parseFloat(formData.get('price')),
                    category_id: formData.get('category_id') || null,
                    in_stock: formData.get('in_stock') === 'true'
                };
                
                if (imageUrl) {
                    productData.image_url = imageUrl;
                }
                
                if (editingProductId) {
                    if (!imageUrl) {
                        // Don't overwrite existing image if no new one is uploaded
                        delete productData.image_url;
                    }
                    await ProductsAPI.update(editingProductId, productData);
                } else {
                    await ProductsAPI.create(productData);
                }
                
                closeProductModal();
                loadProducts();
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Error saving product: ' + error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Save Product';
            }
        });

        // Initialize the page
        (async () => {
            await AdminAuth.requireAuth();
            setupMobileNav();
            loadCategories();
            loadProducts();
        })();
    </script>
</body>
</html>
